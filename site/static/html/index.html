<!DOCTYPE html>
<meta charset="utf-8">
<style>

  .node {
    stroke: #fff;
    stroke-width: 1.5px;
  }

  .link {
    stroke: #999;
    stroke-opacity: .6;
  }

</style>
<head>
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
  <link href="/static/css/c3.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/static/css/site.css" type="text/css">
</head>
<body>
  <div class="container">
    <form class="pure-form" id="select-stock">
      <legend>Select a stock symbol to search for</legend>
      <input type="text" placeholder="GE">
      <button type="submit" class="pure-button pure-button-primary">Get data</button>
    </form>
    <div id="progress-indicator"></div>
    <div class="pure-g">
      <div class="pure-u-12-24" id="user-graph">
      </div>
      <div class="pure-u-4-24" id="node-data">
        <dl>
          <dt class="community-size">Nr. of members</dt>
          <dd>100</dd>
          <dt class="community-shared-stocks">Shared stocks</dt>
          <dd>.45</dd>
          <dt class="community-clustering-coef">Clustering coef.</dt>
          <dd>2.3</dd>
        </dl>
      </div>
      <div class="pure-u-8-24">
        <h2>Twitters stock advertisers</h2>
        <p>Twitter has a large base of users that simply talk about and promote stock. By looking at what stocks they tweet about we find that some of the most frequent tweeters are related to each other in that they always tweet about the same stocks. This possibly means that these twitter acounts are either fakes, paid to promote specific stocks or connected in a community of interest.</p>
      </div>
    </div>
    <div class="pure-g">
      <div class="pure-u-2-3" id="stock-timeseries"></div>
      <div class="pure-u-1-3">
        <h2>Volume, price and twitter mentions</h2>
        <p>If there is a relation between twitter sentiment and stock prices it could be reflected in the sheer number of mentions a stock gets on Twitter. Here the number of mentions and the.</p>
      </div>
    </div>
    <div class="pure-g">
      <div class="pure-u-2-3" id="bear-bull-area"></div>
      <div class="pure-u-1-3" id="bear-bull-pie"></div>
    </div>
  </div>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script src="/static/js/c3.js"></script>
  <script src="/static/js/jquery-2.1.4.min.js"></script>
  <script>
    $('#select-stock').submit(function(e) {
      symbol = $('#select-stock input:first').val();
      $('#progress-indicator').addClass('progress');
      $.get("/stock", {'symbol':symbol}, function(data) {
        console.log(data)
        var self = this;
        self.data = data;
        $('#progress-indicator').removeClass('progress');
        stock_chart.unload({
          done: function() {
            weekly_bear_bull_breakdown.unload({
              done: function() {
                tweet_vol_chart.unload({
                  done: function () {
                    var data = self.data.data
                    var dates = data[0];
                    var price = data[1];
                    var volume = data[2];
                    var tweet_vol = data[3];
                    var bullish = data[4];
                    var bearish = data[5];
                    var neutral = ['neutral'];
                    for (var i=1; i < dates.length; i++) {
                      neutral[i] = tweet_vol[i] - bullish[i] - bearish[i] + 10;
                    }
                    var bull_sum = bullish.slice(1,bullish.length).reduce(function(x,y) {return x+y;})
                    var bear_sum = bearish.slice(1,bearish.length).reduce(function(x,y) {return x+y;})
                    //chart.load({columns:data.data});
                    weekly_bear_bull_breakdown.load({columns: [
                      ['bullish', bull_sum],
                      ['bearish', bear_sum]
                    ]});
                    tweet_vol_chart.load({
                      x: 'x',
                      columns:
                        [dates, bullish, bearish, neutral],
                      types: {
                        bullish: 'area',
                        bearish: 'area',
                        neutral: 'area'
                      },
                      groups: [['bullish', 'bearish', 'neutral']],
                      axis: {
                        x: {
                          type: 'timeseries',
                          tick: {
                            format: '%Y-%m-%d'
                          }
                        },
                        y: {
                          label: 'Tweet count'
                        }
                      }
                      
                    });
                    stock_chart.load({
                      x: 'x',
                      columns: [dates, price, volume],
                      axes: {
                        volume: 'y2'
                      },
                      types: {
                        price: 'line',
                        volume: 'bar'
                      },
                      axis: {
                        y2: {
                          label: 'Traded volume'
                        },
                        y: {
                          label: 'Price [$]'
                        }
                      }
                    });
                  }
                });
              }
            });
          }
        });
      });
      return false;
    });

    // Show the volume / price data in a timeseries chart
    var stock_chart = c3.generate({
      bindto: '#stock-timeseries',
      data: {
        x: 'x',
        // xFormat: '%Y%m%d', // 'xFormat' can be used as custom format of 'x'
        columns: [
          ['x', '2013-01-01', '2013-01-02', '2013-01-03', '2013-01-04', '2013-01-05', '2013-01-06'],
          //['x', '20130101', '20130102', '20130103', '20130104', '20130105', '20130106'],
          ['price', 30, 200, 100, 400, 150, 250],
          ['volume', 130, 340, 200, 500, 250, 350]
        ],
        axes: {
          volume: 'y2'
        },
        types: {
          price: 'line',
          volume: 'bar'
        }
      },
        axis: {
          y2: {
            show: true,
            label: 'Traded volume'
          },
          y: {
            label: 'Price [$]'
          },
          x: {
            type: 'timeseries',
            tick: {
              format: '%Y-%m-%d'
            }
          },
        }
      });

    // Show the bear/bull ratio in  a pie chart
    var weekly_bear_bull_breakdown = c3.generate({
      bindto:'#bear-bull-pie',
      data: {
        // iris data from R
        columns: [
            ['data1', 30],
            ['data2', 120],
        ],
        type : 'pie',
        onclick: function (d, i) { console.log("onclick", d, i); },
        onmouseover: function (d, i) { console.log("onmouseover", d, i); },
        onmouseout: function (d, i) { console.log("onmouseout", d, i); }
      }
    });

    // Show the tweet volume in a stacked area chart
    var tweet_vol_chart = c3.generate({
      bindto:'#bear-bull-area',
      data: {
          x: 'x',
          columns: [
              ['x', '2013-01-01', '2013-01-02', '2013-01-03', '2013-01-04', '2013-01-05', '2013-01-06'],
              ['bullish', 300, 350, 300, 0, 0, 120],
              ['bearish', 300, 350, 300, 0, 0, 120],
              ['neutral', 130, 100, 140, 200, 150, 50]
          ],
          types: {
              bullish: 'area',
              bearish: 'area',
              neutral: 'area'
              // 'line', 'spline', 'step', 'area', 'area-step' are also available to stack
          },
          groups: [['bullish', 'bearish', 'neutral']]
      },
      axis: {
        x: {
          type: 'timeseries',
          tick: {
            format: '%Y-%m-%d'
          }
        },
        y: {
          label: 'Tweet volume'
        }
      }
    });

    var width = 960,
    height = 500;

    var color = d3.scale.category20();

    var force = d3.layout.force()
    .charge(-60)
    .linkDistance(200)
    .size([width, height]);

    var svg = d3.select("#user-graph").append("svg")
    .attr("width", width)
    .attr("height", height);

    d3.json("static/data/induced_communities.json", function(error, graph) {
      if (error) throw error;

      force
      .nodes(graph.nodes)
      .links(graph.links)
      .start();

      var link = svg.selectAll(".link")
      .data(graph.links)
      .enter().append("line")
      .attr("class", "link")
      .style("stroke-width", function(d) { return Math.sqrt(d.value); });

      var node = svg.selectAll(".node")
      .data(graph.nodes)
      .enter().append("circle")
      .attr("class", "node")
      .attr("r", function(d) {return (1+Math.log(d.size))*3})
      .style("fill", function(d) { return color(d.group); })
      .call(force.drag);

      node.append("size")
      .text(function(d) { return d.size; });

      force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; });

        node.attr("cx", function(d) { return d.x = Math.max(15, Math.min(width - 15, d.x)); })
        .attr("cy", function(d) { return d.y = Math.max(15, Math.min(height - 15, d.y)); })
      });
    });

  </script>